import streamlit as st
from openai import OpenAI
from config import get_config

cfg = get_config()
client = OpenAI(api_key=cfg.OPENAI_API_KEY)

def transcribe_audio(wav_path: str) -> str:
    st.info("üîç –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ–º –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ Whisper API‚Ä¶")
    try:
        with open(wav_path, "rb") as audio_file:
            transcript = client.audio.transcriptions.create(
                model=cfg.TRANSCRIBE_MODEL, 
                file=audio_file,
                temperature=cfg.TEMP_TRANSCRIBE,
                response_format="text"
            )
        st.success("‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞.")
        return transcript
    except Exception as e:
        st.error(f"üö® –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏: {str(e)}")
        st.stop()

def generate_document(transcript: str) -> str:
    st.info("üìù –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞‚Ä¶")
    prompt = (
        "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –≤ –∫—Ä–µ–¥–∏—Ç–Ω–æ–º —Ü–µ–Ω—Ç—Ä–µ. "
        "–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ–ø—Ä–µ–¥–µ–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:\n\n"
        
        "### –ù–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Å 12.06):\n"
        "1. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç '–Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏' –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ ‚Üí '–ù–µ—Ç –≤—Ä–µ–º–µ–Ω–∏': —Å—Ç–∞–≤–∏–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å\n"
        "2. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ—É–≤–µ—Ä–µ–Ω –≤ —Å—É–º–º–µ –¥–æ–ª–≥–∞ ‚Üí '–ù–µ—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å—É–º–º–µ –¥–æ–ª–≥–∞': "
        "–µ—Å–ª–∏ —Å—É–º–º–∞ >300 —Ç—ã—Å. —Ä—É–±. - –ø–µ—Ä–µ–¥–∞–µ–º, –∏–Ω–∞—á–µ —É—Ç–æ—á–Ω—è–µ–º\n\n"
        
        "### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞ (—Å 09.06):\n"
        "1. –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∏–ø–æ—Ç–µ–∫–∞ ‚Üí '–ò–ø–æ—Ç–µ–∫–∞': –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º\n"
        "2. –ï—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –∞–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç ‚Üí '–ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç': –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º\n"
        "3. –ï—Å–ª–∏ –≤—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥ ‚Üí '–í—ã—Å–æ–∫–∏–π –¥–æ—Ö–æ–¥': —Å—á–∏—Ç–∞–µ–º —Ñ–æ—Ä–º—É–ª—É\n"
        "4. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –≤ –≥–æ—Ä–æ–¥–µ ‚Üí '–ù–µ –≤ –≥–æ—Ä–æ–¥–µ': —Å—Ç–∞–≤–∏–º –∑–∞–¥–∞—á—É –Ω–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω\n"
        "5. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è ‚Üí '–ü—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ': –Ω–µ –ª–∏–¥\n"
        "6. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –≤—Å—ë –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Üí '–•–æ—Ç—è—Ç –≤—Å—ë –±–µ—Å–ø–ª–∞—Ç–Ω–æ': –Ω–µ –ª–∏–¥\n\n"
        
        "### –û—Å—Ç–∞–≤–ª—è–µ–º (–ø–µ—Ä–µ–¥–∞–µ–º):\n"
        "–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞\n\n"
        
        "–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:\n"
        "### –ù–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ù–ï –ø–æ–¥–ª–µ–∂–∞—â–∏–µ –ø–µ—Ä–µ–¥–∞—á–µ —Å –ö–¶ —Å 12.06:\n"
        "<—Å–ø–∏—Å–æ–∫ —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π>\n\n"
        "### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—Ä–∞–∫–∞, –ù–ï –ø–æ–¥–ª–µ–∂–∞—â–∏–µ –ø–µ—Ä–µ–¥–∞—á–µ —Å –ö–¶ —Å 09.06:\n"
        "<—Å–ø–∏—Å–æ–∫ —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π>\n\n"
        "### –û—Å—Ç–∞–≤–ª—è–µ–º (–ø–µ—Ä–µ–¥–∞–µ–º):\n"
        "<—Å–ø–∏—Å–æ–∫ —Å –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π>\n\n"
        
        f"–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞:\n{transcript}\n\n"
        "–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –¥–æ–∫—É–º–µ–Ω—Ç–æ–º –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π!"
    )
    
    try:
        response = client.chat.completions.create(
            model=cfg.GPT_MODEL,
            messages=[
                {"role": "system", "content": "–¢—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –≤ –∫—Ä–µ–¥–∏—Ç–Ω–æ–º —Ü–µ–Ω—Ç—Ä–µ"},
                {"role": "user", "content": prompt}
            ],
            temperature=cfg.TEMP_SUMMARY,
            max_tokens=1000
        )
        doc = response.choices[0].message.content
        st.success("‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.")
        return doc.strip()
    except Exception as e:
        st.error(f"üö® –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {str(e)}")
        st.stop()
        